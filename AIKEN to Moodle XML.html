<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>AIKEN to Moodle XML Converter</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 20px;
    }
    .container {
      max-width: 600px;
      margin: 0 auto;
    }
    input[type="file"] {
      margin-bottom: 10px;
    }
    button {
      margin-top: 10px;
      padding: 10px 20px;
      font-size: 1em;
      cursor: pointer;
    }
    .preview-area {
      margin-top: 20px;
      padding: 10px;
      border: 1px solid #ccc;
      font-family: monospace;
      white-space: pre-wrap;
      max-height: 300px;
      overflow-y: auto;
    }
    #downloadLink {
      display: none; /* Hidden until we have something to download */
      margin-top: 20px;
    }
  </style>
</head>
<body>

<div class="container">
  <h1>AIKEN to Moodle XML Converter</h1>
  
  <p>
    Select a <code>.txt</code> file containing AIKEN-format questions. Then click "Convert &amp; Download".
  </p>
  
  <input type="file" id="fileInput" accept=".txt" />
  <br/>
  <button id="convertBtn">Convert &amp; Download XML</button>

  <div id="previewContainer" style="display:none;">
    <h2>Preview (Moodle XML)</h2>
    <div class="preview-area" id="xmlPreview"></div>
  </div>

  <!-- This link will be used to download the generated XML -->
  <a id="downloadLink" href="#" download="moodle_questions.xml">Download Converted XML</a>
</div>

<script>
/**
 * Converts AIKEN-formatted text into Moodle XML format.
 * 
 * @param {string} aikenInput The raw AIKEN text.
 * @returns {string} XML string in Moodle format
 */
function convertAikenToMoodleXml(aikenInput) {
  // Split input into lines
  const lines = aikenInput.split(/\r?\n/);

  // Start building the XML
  let quizXml = '<quiz>\n';

  let questionText = '';
  let answers = [];
  let correctAnswer = '';

  /**
   * Build the Moodle XML for a single multiple-choice question.
   */
  function buildQuestionXml(question, answersArr, correct) {
    // We'll use the first ~40 characters as the question's "name" in Moodle
    const questionName = question.length > 40
      ? question.substring(0, 40) + '...'
      : question;

    let qXml = '  <question type="multichoice">\n';
    qXml += '    <name>\n';
    qXml += '      <text><![CDATA[' + questionName + ']]></text>\n';
    qXml += '    </name>\n';
    qXml += '    <questiontext format="html">\n';
    qXml += '      <text><![CDATA[' + question + ']]></text>\n';
    qXml += '    </questiontext>\n';
    qXml += '    <defaultgrade>1</defaultgrade>\n';
    qXml += '    <penalty>0</penalty>\n';
    qXml += '    <single>true</single>\n';
    qXml += '    <shuffleanswers>true</shuffleanswers>\n';

    // Add each answer (fraction="100" if correct, else "0")
    answersArr.forEach(ansObj => {
      const fractionValue = (ansObj.label === correct) ? '100' : '0';
      qXml += '    <answer fraction="' + fractionValue + '" format="html">\n';
      qXml += '      <text><![CDATA[' + ansObj.text + ']]></text>\n';
      qXml += '      <feedback>\n';
      qXml += '        <text><![CDATA[]]></text>\n';
      qXml += '      </feedback>\n';
      qXml += '    </answer>\n';
    });

    qXml += '  </question>\n';
    return qXml;
  }

  for (let i = 0; i < lines.length; i++) {
    const line = lines[i].trim();
    if (!line) {
      // Skip blank lines
      continue;
    }

    // Check if line looks like an answer choice: "A. something" or "A) something"
    const ansMatch = line.match(/^([A-Za-z])[\).]\s+(.*)/);
    if (ansMatch) {
      // It's an answer
      const label = ansMatch[1].toUpperCase();
      const ansText = ansMatch[2].trim();
      answers.push({ label, text: ansText });
    }
    else if (line.toUpperCase().startsWith('ANSWER:')) {
      // This is the correct-answer line
      correctAnswer = line.split(':')[1].trim().toUpperCase();

      // Build and append the question XML
      quizXml += buildQuestionXml(questionText, answers, correctAnswer);

      // Reset for next question
      questionText = '';
      answers = [];
      correctAnswer = '';
    }
    else {
      // It's part of the question text
      if (!questionText) {
        questionText = line; 
      } else {
        // (Optional) Append multiple lines to question text
        questionText += '\n' + line;
      }
    }
  }

  quizXml += '</quiz>';
  return quizXml;
}

document.getElementById('convertBtn').addEventListener('click', () => {
  const fileInput = document.getElementById('fileInput');
  if (!fileInput.files || fileInput.files.length === 0) {
    alert('Please select a .txt file containing AIKEN-format questions.');
    return;
  }

  const file = fileInput.files[0];
  const reader = new FileReader();

  reader.onload = function(e) {
    const fileContents = e.target.result;
    const moodleXml = convertAikenToMoodleXml(fileContents);

    // Display a preview
    const previewContainer = document.getElementById('previewContainer');
    const xmlPreview = document.getElementById('xmlPreview');
    previewContainer.style.display = 'block';
    xmlPreview.textContent = moodleXml;

    // Create a downloadable Blob
    const blob = new Blob([moodleXml], { type: 'application/xml' });
    const url = URL.createObjectURL(blob);

    // Provide a link for the user to download
    const downloadLink = document.getElementById('downloadLink');
    downloadLink.href = url;
    // Customize the download filename if you like:
    downloadLink.download = file.name.replace(/\.txt$/i, '') + '_converted.xml';
    downloadLink.style.display = 'inline-block';
  };

  reader.readAsText(file);
});
</script>

</body>
</html>
